---
title: "Аварский диктант"
author: "Г. Мороз"
date: "`r lubridate::today()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.width = 12, fig.height = 7)
```

Данные являются результатом проведения аварского диктанта в Махачкале и Санкт-Петербурге. Спасибо Расулу Абдулхаликову за то, что поделился данными. Расул, сюда нужно больше текста про этот проект или может быть ссылку...

```{r}
library(tidyverse)
theme_set(theme_bw())
df <- readxl::read_xls("data/Аварский диктант итоги. Махачкала и Питер.xls")
df %>% 
  count(Город) %>% 
  mutate(percantage = round(n/sum(n)*100)) ->
  city
df %>% 
  count(Пол) %>% 
  mutate(percantage = round(n/sum(n)*100)) ->
  sex
```

Всего приняли участие `nrow(df)` человек. В датасете следующие переменные:

* Фамилия
* Имя
* Возраст (заполнен `r sum(!is.na(df$Лет))` раз, `r round(sum(!is.na(df$Лет))/nrow(df)*100)`%)
* Город (МХК `r city$percantage[1]`% vs СПб `r city$percantage[2]`%)
* Пол (Ж `r sex$percantage[1]`%, М `r sex$percantage[2]`%)
* Количество ошибок
* Оценка

Визуализируем все наши переменные (возьмем подгруппу людей, которые указали свой возраст)
```{r}
df %>% 
  filter(!is.na(Лет)) %>% 
  ggplot(aes(Лет, Ошибок, color = Пол))+
  geom_point()+
  geom_smooth(method = "glm", 
              method.args = list(family = poisson), 
              aes(color = Пол), se = FALSE)+
  scale_y_continuous(breaks = c(0:10, 15, 20, 30))+
  facet_wrap(~Город)+
  labs(x = "возраст (в годах)", y = "количество ошибок", title = str_c("Количество ошибок в зависимости\nот города участия, пола и возраста участников (", sum(!is.na(df$Лет)), " человек)"))+
  ggthemes::scale_colour_tableau(name=NULL)
```

Каждая точка на графике --- это один человек (некоторые точки наслаиваются друг на друга). Линия --- пуассоновская регрессия, которую можно считать некоторой оценкой связи количества ошибок и возраста участников разного пола в каждом из городов. Как видно из графика, участники из Махачкалы справились значительно лучше, и у них наблюдается отрицательная связь: чем больше возраст, тем меньше ошибок (у женщин в Махачкале ошибок в среднем меньше, чем у мужчин). В Санкт-Петербурге та же картина: чем старше, тем лучше справились, но женщины практически не изменяются с возрастом, мужчины стремительно становятся лучше (хотя данных очень мало, чтобы хоть сколько-то верить в тренд в Санкт-Петербурге). Так же участники из Санкт-Петербурга демонстрируют в среднем результат на уровне слабых результатов из Махачкалы.

Посмотрим теперь те же самые данные, но без переменной возраст (ведь мы теряем так много данных):

```{r}
df %>% 
  ggplot(aes(Пол, Ошибок, color = Пол))+
  geom_boxplot()+
  geom_jitter()+
  geom_smooth(method = "glm", 
              method.args = list(family = poisson), 
              aes(color = Пол), se = FALSE)+
  scale_y_continuous(breaks = c(0:10, 15, 20, 30))+
  facet_wrap(~Город)+
  labs(x = "возраст (в годах)", y = "количество ошибок", title = str_c("Количество ошибок в зависимости\nот города участия и пола участников (", nrow(df), " человека)"))+
  ggthemes::scale_colour_tableau(name=NULL)
```

На данном графике видно, что в целом, лучше всего справляются женщины из Махачкалы, которые делают около 2 ошибок, мужчины делают около 3, а в Санкт-Петербурге женшины делают в среднем 5 ошибок, а мужчины 8.